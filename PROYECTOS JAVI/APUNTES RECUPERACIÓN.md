# Netplan o Interfaces (Ubuntu o Desktop)
## Netplan
```bash
network:
    ethernets:
        enp0s3:
            dhcp4: no
            addresses:
              - 192.168.110.21/24
            routes:
              - to: default
                via: 192.168.110.1
            nameservers:
              addresses:
                - 8.8.8.8
    version: 2
```

## Interfaces
```bash
auto enp0s3
iface enp0s3 inet static
    address 192.168.110.80
    netmask 255.255.255.0
    gateway 192.168.110.1
    dns-nameservers 8.8.8.8
```

## Bind9
``` bash
sudo apt install bind9 -y
```

``` bash
tee /etc/bind/named.conf.options > /dev/null <<EOF
options {
        directory "/var/cache/bind";

        // If there is a firewall between you and nameservers you want
        // to talk to, you may need to fix the firewall to allow multiple
        // ports to talk.  See http://www.kb.cert.org/vuls/id/800113

        // If your ISP provided one or more IP addresses for stable
        // nameservers, you probably want to use them as forwarders.
        // Uncomment the following block, and insert the addresses replacing
        // the all-0's placeholder.

        forwarders {
                8.8.8.8;
        };

        //========================================================================
        // If BIND logs error messages about the root key being expired,
        // you will need to update your keys.  See https://www.isc.org/bind-keys
        //========================================================================
        dnssec-validation auto;

        listen-on-v6 { any; };
};
EOF
```

``` bash
tee /etc/bind/named.conf.local > /dev/null <<EOF
//
// Do any local configuration here
//

// Consider adding the 1918 zones here, if they are not used in your
// organization
//include "/etc/bind/zones.rfc1918";

zone "ribetown.cat" {
        type master;
        file "/etc/bind/zona_directa.db";
};

zone "110.168.192.in-addr.arpa" {
        type master;
        file "/etc/bind/zona_inversa.db";
};
EOF
```

```bash
cp /etc/bind/db.empty /etc/bind/zona_directa.db
```

```bash
tee /etc/bind/zona_directa.db > /dev/null <<EOF
; BIND reverse data file for empty rfc1918 zone
;
; DO NOT EDIT THIS FILE - it is used for multiple zones.
; Instead, copy it, edit named.conf, and use that copy.
;
\$TTL    86400
@       IN      SOA     ribetown.cat. root.ribetown.cat. (
                              1         ; Serial
                         604800         ; Refresh
                          86400         ; Retry
                        2419200         ; Expire
                          86400 )       ; Negative Cache TTL
;
@       IN      NS      dns.ribetown.cat.
@       IN      A       192.168.110.61
alma    IN      A       192.168.110.61
dns     IN      A       192.168.110.61
www     IN      A       192.168.110.61
admin   IN      A       192.168.110.61
vendes  IN      A       192.168.110.61
EOF
```

```bash
cp /etc/bind/zona_directa.db /etc/bind/zona_inversa.db
```

```bash
tee /etc/bind/zona_inversa.db > /dev/null <<EOF
; BIND reverse data file for empty rfc1918 zone
;
; DO NOT EDIT THIS FILE - it is used for multiple zones.
; Instead, copy it, edit named.conf, and use that copy.
;
\$TTL    86400
@       IN      SOA     ribetown.cat. root.ribetown.cat. (
                              1         ; Serial
                         604800         ; Refresh
                          86400         ; Retry
                        2419200         ; Expire
                          86400 )       ; Negative Cache TTL
;
@       IN      NS      dns.ribetown.cat.
61      IN      PTR     alma.ribetown.cat.
61      IN      PTR     vendes.ribetown.cat.
61      IN      PTR     www.ribetown.cat.
61      IN      PTR     admin.ribetown.cat.
EOF
```

```bash
systemctl restart bind9
```

```bash

######## COMPROBACIONES ##########

root@serveralumne:~# nslookup javigonzalez.cat 192.168.110.80
Server:         192.168.110.80
Address:        192.168.110.80#53

Name:   javigonzalez.cat
Address: 192.168.110.80

root@serveralumne:~# nslookup javigonzalez.cat 192.168.110.80
Server:         192.168.110.80
Address:        192.168.110.80#53

Name:   javigonzalez.cat
Address: 192.168.110.80

root@serveralumne:~# nslookup dns.javigonzalez.cat 192.168.110.80
Server:         192.168.110.80
Address:        192.168.110.80#53

Name:   dns.javigonzalez.cat
Address: 192.168.110.80

root@serveralumne:~# nslookup pccasa.javigonzalez.cat 192.168.110.80
Server:         192.168.110.80
Address:        192.168.110.80#53

Name:   pccasa.javigonzalez.cat
Address: 192.168.110.80

root@serveralumne:~#
```

# DHCP

``` bash
apt install isc-dhcp-server -y
```

``` bash
tee /etc/dhcp/dhcpd.conf > /dev/null <<EOF
option domain-name-servers 192.168.110.61;
option domain-name "ribetown.cat";
option subnet-mask 255.255.255.0;
default-lease-time 600;
max-lease-time 7200;

subnet 192.168.110.0 netmask 255.255.255.0 {
    range 192.168.110.100 192.168.110.249;
    option routers 192.168.110.1;
    option broadcast-address 192.168.110.255;
    option domain-name-servers 192.168.110.61;
    default-lease-time 6000;
}

host client1 {
    hardware ethernet 08:00:27:f9:21:14;         # MAC del client 1
    fixed-address 192.168.110.60;               # IP fixa reservada per client 1
    option host-name "client1";
}

host client2 {
    hardware ethernet 00:aa:bb:cc:dd:ee;         # MAC del client 2 
    fixed-address 192.168.110.59;               # IP fixa reservada per client 2
    option host-name "client2";
}
EOF
```

```bash
systemctl restart isc-dhcp-server
```
# APACHE2

``` bash
apt install php8.3 libapache2-mod-php8.3 -y
apt install php libapache2-mod-php -y
a2enmod php8.3
systemctl restart apache2
```

```bash
sudo mkdir -p /var/www/vendes.ribetown.cat
sudo mkdir -p /var/www/www.ribetown.cat
sudo mkdir -p /var/www/admin.ribetown.cat
```

```bash
echo "<?php echo 'Benvingut a la web de VENDES'; ?>" | sudo tee /var/www/vendes.ribetown.cat/index.php
echo "<?php echo 'Benvingut a la WEB de l\'empresa'; ?>" | sudo tee /var/www/www.ribetown.cat/index.php
echo "<?php echo 'Benvingut a la zona ADMIN'; ?>" | sudo tee /var/www/admin.ribetown.cat/index.php
```

```bash
tee /etc/apache2/sites-available/vendes.ribetown.cat.conf > /dev/null <<EOF
<VirtualHost *:80>
    ServerName vendes.ribetown.cat
    ServerAdmin admin@ribetown.cat
    DocumentRoot /var/www/vendes.ribetown.cat
    CustomLog /var/log/apache2/vendes.ribetown.cat-access_log combined
    ErrorLog /var/log/apache2/vendes.ribetown.cat-error_log
</VirtualHost>
EOF
```

```bash
tee /etc/apache2/sites-available/www.ribetown.cat.conf > /dev/null <<EOF
<VirtualHost *:80>
    ServerName www.ribetown.cat
    ServerAdmin admin@ribetown.cat
    DocumentRoot /var/www/www.ribetown.cat
    CustomLog /var/log/apache2/www.ribetown.cat-access_log combined
    ErrorLog /var/log/apache2/www.ribetown.cat-error_log
</VirtualHost>
EOF
```

```bash
tee /etc/apache2/sites-available/admin.ribetown.cat.conf > /dev/null <<EOF
<VirtualHost *:80>
    ServerName admin.ribetown.cat
    ServerAdmin admin@ribetown.cat
    DocumentRoot /var/www/admin.ribetown.cat
    CustomLog /var/log/apache2/admin.ribetown.cat-access_log combined
    ErrorLog /var/log/apache2/admin.ribetown.cat-error_log
</VirtualHost>
EOF
```

```bash
a2ensite vendes.ribetown.cat.conf
a2ensite www.ribetown.cat.conf
a2ensite admin.ribetown.cat.conf
a2dissite 000-default.conf
systemctl restart apache2
```

```
http://www.ribetown.cat/
http://admin.ribetown.cat/
http://vendes.ribetown.cat/
```

# MARIADB PURE-FTPD-MYSQL
```bash
apt install mariadb-server -y
```

```bash
apt install pure-ftpd-mysql -y
groupadd -g 2001 grupftp
adduser --system --no-create-home --disabled-login --uid 2001 --gid 2001 usuariftp
usermod -aG grupftp usuariftp
mysql -u root -p
contrasenya
```

```bash
ALTER USER 'usuariftp'@'localhost' IDENTIFIED BY 'contrasenya';
FLUSH PRIVILEGES;
```

```bash
nano /etc/mysql/mariadb.conf.d/50-server.cnf

# Comentamos la linea bind_address

# bind-address            = 127.0.0.1
```

```bash
CREATE USER IF NOT EXISTS 'usuariftp'@'%' IDENTIFIED BY 'contrasenya';
GRANT ALL PRIVILEGES ON *.* TO 'usuariftp'@'%';
FLUSH PRIVILEGES;
```

```bash
service mariadb restart
```

``` sql
CREATE DATABASE usersftp;
USE usersftp;

CREATE TABLE comptes (
    id INT AUTO_INCREMENT PRIMARY KEY,
    login VARCHAR(30) NOT NULL UNIQUE,
    estatus TINYINT(1) NOT NULL CHECK (estatus IN (0, 1)),
    contrasenya VARCHAR(150) NOT NULL,
    id_usuari VARCHAR(10),
    id_grup VARCHAR(10),
    directori VARCHAR(150),
    ample_pujada INT(10),
    ample_baixada INT(10),
    comentari TEXT,
    acces_ip VARCHAR(100),
    quota_mida INT(10),
    quota_fitxer INT(10)
);
```


```bash
tee /etc/pure-ftpd/db/mysql.conf > /dev/null <<'EOF'
##############################################
#                                            #
# Sample Pure-FTPd Mysql configuration file. #
# See README.MySQL for explanations.         #
#                                            #
##############################################


# Optional : MySQL server name or IP. Don't define this for unix sockets.

# MYSQLServer     127.0.0.1


# Optional : MySQL port. Don't define this if a local unix socket is used.

# MYSQLPort       3306


# Optional : define the location of mysql.sock if the server runs on this host.

MYSQLSocket      /var/run/mysqld/mysqld.sock


# Mandatory : user to bind the server as.

MYSQLUser       usuariftp


# Mandatory : user password. You must have a password.

MYSQLPassword   contrasenya


# Mandatory : database to open.

MYSQLDatabase   usersftp


# Mandatory : how passwords are stored
# Valid values are : "cleartext", "argon2", "scrypt", "crypt", and "any"

MYSQLCrypt      argon2


# In the following directives, parts of the strings are replaced at
# run-time before performing queries :
#
# \L is replaced by the login of the user trying to authenticate.
# \I is replaced by the IP address the user connected to.
# \P is replaced by the port number the user connected to.
# \R is replaced by the IP address the user connected from.
# \D is replaced by the remote IP address, as a long decimal number.
#
# Very complex queries can be performed using these substitution strings,
# especially for virtual hosting.

# Query to execute in order to fetch the password

MYSQLGetPW      SELECT contrasenya FROM comptes WHERE login="\L" AND estatus="1" AND (acces_ip = "*" OR acces_ip LIKE "\R")


# Query to execute in order to fetch the system user name or uid
MYSQLGetUID     SELECT id_usuari FROM comptes WHERE login="\L" AND estatus="1" AND (acces_ip = "*" OR acces_ip LIKE "\R")


# Optional : default UID - if set this overrides MYSQLGetUID

#MYSQLDefaultUID 1000


# Query to execute in order to fetch the system user group or gid

MYSQLGetGID     SELECT id_grup FROM comptes WHERE login="\L" AND estatus="1" AND (acces_ip = "*" OR acces_ip LIKE "\R")


# Optional : default GID - if set this overrides MYSQLGetGID

#MYSQLDefaultGID 1000


# Query to execute in order to fetch the home directory

MYSQLGetDir     SELECT directori FROM comptes WHERE login="\L" AND estatus="1" AND (acces_ip = "*" OR acces_ip LIKE "\R")


# Optional : query to get the maximal number of files
# Pure-FTPd must have been compiled with virtual quotas support.

MySQLGetQTAFS  SELECT quota_fitxer FROM comptes WHERE login="\L" AND estatus="1" AND (acces_ip = "*" OR acces_ip LIKE "\R")


# Optional : query to get the maximal disk usage (virtual quotas)
# The number should be in Megabytes.
# Pure-FTPd must have been compiled with virtual quotas support.

MySQLGetQTASZ  SELECT quota_mida FROM comptes WHERE login="\L" AND estatus="1" AND (acces_ip = "*" OR acces_ip LIKE "\R")


# Optional : ratios. The server has to be compiled with ratio support.

# MySQLGetRatioUL SELECT ULRatio FROM users WHERE User='\L'
# MySQLGetRatioDL SELECT DLRatio FROM users WHERE User='\L'


# Optional : bandwidth throttling.
# The server has to be compiled with throttling support.
# Values are in KB/s .

MySQLGetBandwidthUL SELECT ample_pujada FROM comptes WHERE login="\L" AND estatus="1" AND (acces_ip = "*" OR acces_ip LIKE "\R")
MySQLGetBandwidthDL SELECT ample_baixada FROM comptes WHERE login="\L" AND estatus="1" AND (acces_ip = "*" OR acces_ip LIKE "\R")


# Enable ~ expansion. NEVER ENABLE THIS BLINDLY UNLESS :
# 1) You know what you are doing.
# 2) Real and virtual users match.

# MySQLForceTildeExpansion 1


# If you're using a transactionnal storage engine, you can enable SQL
# transactions to avoid races. Leave this commented if you are using the
# traditional MyIsam engine.

# MySQLTransactions On
EOF
```

```bash
echo "yes" > /etc/pure-ftpd/conf/ChrootEveryone
echo "yes" > /etc/pure-ftpd/conf/CreateHomeDir
service pure-ftpd-mysql restart
```

``` bash
apt install argon2 -y

echo -n 'vendes123' | argon2 somesalt -id -t 2 -m 16 -p 1

$argon2id$v=19$m=65536,t=2,p=1$c29tZXNhbHQ$Jamu5MWR2rFp4fvNl3DEHre4wlvwyjic/hE2JM/H/Ys
echo -n 'admin123' | argon2 somesalt -id -t 2 -m 16 -p 1

$argon2id$v=19$m=65536,t=2,p=1$c29tZXNhbHQ$ec7H0s9xd6QIjsDVa5/n5Tp2ydedfgrFtTbJzvAuAwM
echo -n 'www123' | argon2 somesalt -id -t 2 -m 16 -p 1

$argon2id$v=19$m=65536,t=2,p=1$c29tZXNhbHQ$1WO/P5tnUfsu79vcGuRGFcl7X2R5ReBLaEGdd2Myjh0
```

``` sql
USE usersftp;
INSERT INTO comptes (
    login, estatus, contrasenya, id_usuari, id_grup, directori, 
    ample_pujada, ample_baixada, comentari, acces_ip, quota_mida, quota_fitxer
) VALUES
(
    'vendes', 1, '$argon2id$v=19$m=65536,t=2,p=1$c29tZXNhbHQ$Jamu5MWR2rFp4fvNl3DEHre4wlvwyjic/hE2JM/H/Ys',
    '2001', '2001', '/var/www/vendes',
    2001, 2001, 'Usuari de vendes', '*', 5000, 100
);

INSERT INTO comptes (
    login, estatus, contrasenya, id_usuari, id_grup, directori, 
    ample_pujada, ample_baixada, comentari, acces_ip, quota_mida, quota_fitxer
) VALUES
(
    'admin', 1, '$argon2id$v=19$m=65536,t=2,p=1$c29tZXNhbHQ$ec7H0s9xd6QIjsDVa5/n5Tp2ydedfgrFtTbJzvAuAwM',
    '2001', '2001', '/var/www/admin',
    2001, 2001, 'Administrador FTP', '*', 10000, 500
);

INSERT INTO comptes (
    login, estatus, contrasenya, id_usuari, id_grup, directori, 
    ample_pujada, ample_baixada, comentari, acces_ip, quota_mida, quota_fitxer
) VALUES
(
    'www', 1, '$argon2id$v=19$m=65536,t=2,p=1$c29tZXNhbHQ$1WO/P5tnUfsu79vcGuRGFcl7X2R5ReBLaEGdd2Myjh0',
    '2001', '2001', '/var/www/www',
    2001, 2001, 'Usuari per contingut web', '*', 8000, 300
);
```

# MODULOS APACHE2


SELECT * FROM comptes\G

```
Teniu una connexió simbètrica de 1000 Mbps, és a dir:
1000 Mbps pujada
1000 Mbps baixada
Això són 125 MB/s reals (ja que 1 byte = 8 bits).
Si voleu repartir aquest ample de banda de forma equitativa entre 3 usuaris simultanis, cal dividir-lo:
125 MB/s ÷ 3 = 41.66 MB/s per usuari
En kilobytes per segon (KB/s): 41.66 * 1024 ≈ 42666 KB/s
🔒 Límit raonable per usuari (arrodonit amb marge):

~ 42000 KB/s de pujada (ample_pujada) ~ 42000 KB/s de baixada (ample_baixada)
```

